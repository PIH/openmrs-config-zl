<htmlform formUuid="3959f956-b83a-11e7-abc4-cec278b6b50a"
          formName="HIV State" formVersion="1.0">

    <style type="text/css">
        <ifMode mode="VIEW" include="false">

            #data-collection {
                display: inline-block;
                width: 58%;
                vertical-align: top;
            }

            .two-columns {
                column-count: 2;
                -webkit-column-count: 2;
                -moz-column-count: 2;
            }


            p.radio > * {
                display: inline;
                float: none !important;
                min-width: initial;
            }

            form fieldset {
                min-width: 90%;
                display: block;
            }

            .section-container {
                background: #F2F2F2;
                box-shadow: 3px 3px 3px 1px rgba(0, 0, 0, 0.2);
                padding: 10px 5px 10px 15px;
                line-height: 1.5em; /*add this for vertical spacing between elements*/
            }

            .section-container input[type="checkbox"] {
                margin: 0px 5px; /*changed values to vertical, horizontal*/
                top:5px; /*added to offset the checkbox position to line up*/
            }

            .section-container label {
                margin: 0px;
            }

            .section {
                width: 95%;
            }

            form input[type="checkbox"], form input[type="radio"],
                .form input[type="checkbox"], .form input[type="radio"] {
                float: none;
                display: inline-block;
            }

            form label, .form label {
                display: inline-block;
            }

            .boxed {
                background: #F2F2F2;
                box-shadow: 3px 3px 3px 1px rgba(0, 0, 0, 0.2);
                padding: 10px 5px 10px 15px;
            }
        </ifMode>
    </style>

    <ifMode mode="VIEW" include="false" >
        <script type="text/javascript">

            jq(function() {

                var updateEdd = function() {

                    var lastPeriodDate = htmlForm.getValueIfLegal('lastPeriodDate.value');
                    if (typeof lastPeriodDate !== "undefined" &amp;&amp; lastPeriodDate !== null &amp;&amp; (lastPeriodDate.length > 0)) {

                        var today = new Date();
                        var currentEncounterDate = '<lookup expression="encounter.getEncounterDatetime().getTime()"/>';
                        if (typeof currentEncounterDate !== "undefined" &amp;&amp; currentEncounterDate !== null &amp;&amp; (currentEncounterDate.length > 0)) {
                            // calculate the gestational age at the time of the encounter
                            today = new Date(+currentEncounterDate);
                        }

                        var dateObj = getField('lastPeriodDate.value').datepicker('getDate');
                        var newDate = new Date(dateObj);
                        // time difference
                        var timeDiff = Math.abs(today.getTime() - newDate.getTime());
                        // weeks difference = gestational age
                        var diffWeeks = Math.ceil(timeDiff / (1000 * 3600 * 24 * 7));

                        // Estimated Delivery Date = (LMP - 3 months) + 12 months + 7 days
                        newDate.setMonth(newDate.getMonth() - 3);
                        newDate.setFullYear(newDate.getFullYear() + 1);
                        newDate.setDate(newDate.getDate() + 7);

                        var widgetDate = getField('lastPeriodDate.value').datepicker('setDate', newDate).val();
                        getField('lastPeriodDate.value').datepicker('setDate', dateObj);

                        jq('#calculated-edd-and-gestational').show();
                        jq('#calculated-edd').text(widgetDate);
                        jq('#calculated-gestational-age-value').text(diffWeeks + " " + '<uimessage code="pihcore.weeks"/>');

                    } else {
                        jq('#calculated-edd-and-gestational').hide();
                    }
                };

                jq('#calculated-edd-and-gestational').hide();

                jq("#lastPeriodDate input[type='hidden']").change(function() {
                    updateEdd();
                });

                updateEdd();
            });
        </script>
    </ifMode>

    <ifMode mode="VIEW" include="false">
        <h3>
            <uimessage code="pihcore.hiv.state.title"/>
        </h3>

        <script type="text/javascript">
            jq(document).ready(function() {

                // handle our custom functionality for triggering going to the next section when the "Next" button is clicked
                jq('#next').click(function() {
                    window.htmlForm.getBeforeSubmit().push(function () {
                    window.htmlForm.setReturnUrl(window.htmlForm.getReturnUrl() + "&amp;goToNextSection=hiv-state");
                    return true;
                });

                window.htmlForm.submitHtmlForm();
                })

                jq('#submit').click(function() {
                    window.htmlForm.submitHtmlForm();
                })

            });
        </script>
    </ifMode>

    <!-- UHM-4784 Use Lab results or workflow to enter lab data.  Using includeif to comment out the section -->
    <includeIf velocityTest="$patient.gender == 'NoLabEntryHere' ">
        <section id="hiv-surveillance" sectionTag="fieldset" headerTag="legend" headerStyle="title"
                 headerCode="pihcore.labSurveillance">
            <div class="section-container">
                <table>
                    <tr>
                        <th></th>
                        <th colspan="2">
                            <label>
                                <uimessage code="pihcore.result"/>
                            </label>
                        </th>
                        <th>
                            Date
                        </th>
                    </tr>

                    <repeat>
                        <template>
                            <obsgroup groupingConceptId="CIEL:1361">
                                <tr>
                                    <td>
                                        <obs conceptId="CIEL:162087"
                                             answerConceptId="{concept}"
                                             answerCode="pihcore.lab.{name}"
                                             style="checkbox"
                                             toggle="{id: '{name}-lab-toggle', style: 'dim'}"/>
                                    </td>
                                    <td id="{name}-lab-toggle" colspan="2">
                                        <span class="small">
                                            <obs conceptId="{concept}" showUnits="true"/>
                                        </span>
                                    </td>
                                    <td id="{name}-lab-toggle">
                                        <obs conceptId="PIH:3267"/>
                                    </td>
                                </tr>
                            </obsgroup>
                        </template>
                        <render concept="CIEL:730" name="cd4Percent"/>
                        <render concept="CIEL:5497" name="cd4Count"/>
                    </repeat>

                    <!-- Viral Load -->
                    <repeat>
                        <template>
                            <obsgroup groupingConceptId="PIH:HIV viral load construct">
                                <tr>
                                    <td>
                                        <obs conceptId="CIEL:162087"
                                             answerConceptId="{concept}"
                                             answerCode="pihcore.lab.{name}"
                                             style="checkbox"
                                             toggle="{id: '{name}-lab-toggle', style: 'dim'}"/>
                                    </td>
                                    <td id="{name}-lab-toggle">
                                        <span class="small">
                                            <obs conceptId="{concept}" showUnits="true"/>
                                        </span>
                                    </td>
                                    <td id="{name}-lab-toggle">
                                        <obs conceptId="CIEL:1305" style="checkbox"
                                             answerConceptId="CIEL:1306" answerCode="LDL"/>
                                    </td>
                                    <td id="{name}-lab-toggle">
                                        <obs conceptId="PIH:3267"/>
                                    </td>
                                </tr>
                            </obsgroup>
                        </template>
                        <render concept="CIEL:856" name="viralLoad"/>
                    </repeat>

                    <!-- TB resistance -->
                    <repeat>
                        <template>
                            <obsgroup groupingConceptId="CIEL:1361">
                                <tr>
                                    <td>
                                        <obs conceptId="CIEL:162087"
                                             answerConceptId="{concept}"
                                             answerCode="pihcore.lab.{name}"
                                             style="checkbox"
                                             toggle="{id: '{name}-lab-toggle', style: 'dim'}"/>
                                    </td>
                                    <td id="{name}-lab-toggle" colspan="2">
                                        <obs conceptId="{concept}"/>
                                    </td>
                                    <td id="{name}-lab-toggle">
                                        <obs conceptId="PIH:3267"/>
                                    </td>
                                </tr>
                            </obsgroup>
                        </template>
                        <render concept="CIEL:307" name="tbSmear"/>
                    </repeat>
                </table>
            </div>
        </section>
    </includeIf>

    <!-- only show these sections if the patient is < 12 years old-->
    <includeIf velocityTest="$patient.getAge($encounter.getEncounterDatetime()) &lt; 12">
        <section id="hiv-state-stage" sectionTag="fieldset" headerTag="legend" headerStyle="title"
                 headerCode="pihcore.hiv.clinicalStage">
            <div class="boxed">
                <p>
                    <label>
                        <uimessage code="pihcore.hiv.whoStages"/>
                    </label>
                    <obs conceptId="PIH:CURRENT WHO HIV STAGE"
                         answerConceptIds="CIEL:1204,CIEL:1205,CIEL:1206,CIEL:1207"
                         answerLabels="1,2,3,4" style="radio"/>
                </p>
            </div>
        </section>

        <section id="feeding" sectionTag="fieldset" headerTag="legend" headerStyle="title"
                 headerCode="pihcore.feedingAndVaccination" >
            <div class="section-container">
                <p>
                    <label>
                        <uimessage code="pihcore.specifyTypeFeeding"/>
                    </label>
                    <br/>
                    <obs conceptId="CIEL:1151"
                         answerConceptIds="CIEL:5526,CIEL:5254,CIEL:6046" style="radio"
                         answerCodes="zl.breastfeedExclusively,pihcore.formulaExclusively,zl.mixedFeeding"
                         answerSeparator="" />
                </p>

                <p class="radio">
                    <label>
                        <uimessage code="pihcore.providedFormula"/>
                    </label>
                    <obs conceptId="PIH:3581" style="radio"
                         answerConceptIds="CIEL:1065,CIEL:1066"/>
                </p>

                <p class="radio">
                    <label>
                        <uimessage code="pihcore.mch.counselling.breastfeeding"/>
                    </label>
                    <obs conceptId="CIEL:1910" style="radio"
                         answerConceptIds="CIEL:1065,CIEL:1066"/>
                </p>

                <p class="radio">
                    <label>
                        <uimessage code="pihcore.foodBefore6months"/>
                    </label>
                    <obs conceptId="CIEL:5633" style="radio"
                         answerConceptIds="CIEL:1065,CIEL:1066"/>
                </p>

                <p class="radio">
                    <label>
                        <uimessage code="pihcore.formulaPrepTraining"/>
                    </label>
                    <obs conceptId="CIEL:159880" style="radio"
                         answerConceptIds="CIEL:1065,CIEL:1066"/>
                </p>


                <label>
                    <uimessage code="pihcore.vaccinated"/>
                </label>
                <p class="small">
                    <obs id="vaccinate" conceptId="CIEL:164134" style="radio"
                         answerConceptIds="CIEL:1065,CIEL:1066,CIEL:1067"
                         answerSeparator="" >
                        <controls>
                            <when value="CIEL:1065" thenDisplay="#vaccinationCard" />
                        </controls>
                    </obs>
                </p>
                <div id="vaccinationCard">
                    <p>
                        <strong>
                            <uimessage code="pihcore.ifYesVaccinationCard"/>
                        </strong>
                    </p>
                </div>

                <p>
                    <label>
                        <uimessage code="pihcore.childWeaned" />
                    </label>
                    <obs conceptId="CIEL:1152" style="radio"
                         answerConceptIds="CIEL:1065,CIEL:1066"/>
                </p>
            </div>
        </section>

    </includeIf>

    <section id="id-treatment" sectionTag="fieldset" headerTag="legend" headerStyle="title"
             headerCode="pihcore.currentTreatment">
        <div class="section-container">
            <!-- ARV Treatment -->
            <h4>
                <uimessage code="pihcore.arvTreatment"/>
            </h4>

            <p class="small">
                <!-- ToDo: Add reverse toggle for none -->
                <obs id="takingARVs"
                     conceptId="CIEL:160117" style="radio"
                     answerConceptIds="CIEL:1065,CIEL:1107"
                     answerCodes="emr.yes,pihcore.none.label">
                    <controls>
                        <when value="CIEL:1065" thenDisplay="#current-arvs"/>
                    </controls>
                </obs>
            </p>

            <div id="current-arvs">
                <label>
                    <uimessage code="pihcore.hiv.startDateARV"/>
                </label>
                <p class="small">
                    <obs conceptId="CIEL:159599"/>
                </p>
                <div class="two-columns">
                    <p class="radio">
                        <!-- ARV medications  -->
                        <obsgroup groupingConceptId="PIH:13156">
                            <label>
                                <uimessage code="ARV #1"/>:
                            </label>
                            <obs id="currentARV1" conceptId="CIEL:1282"
                                 answerDrugIds="
                                78faac2e-dfbe-11e9-8a34-2a2ae2dbcce4,
                                78f968e6-dfbe-11e9-8a34-2a2ae2dbcce4,
                                78f9739a-dfbe-11e9-8a34-2a2ae2dbcce4,
                                78f95fa4-dfbe-11e9-8a34-2a2ae2dbcce4,
                                78f96a76-dfbe-11e9-8a34-2a2ae2dbcce4,
                                f2a2c2d9-16a6-4138-9074-6fdf3307e107,
                                78f97cfa-dfbe-11e9-8a34-2a2ae2dbcce4,
                                78fab02a-dfbe-11e9-8a34-2a2ae2dbcce4,
                                78f95bc6-dfbe-11e9-8a34-2a2ae2dbcce4,
                                78f967ba-dfbe-11e9-8a34-2a2ae2dbcce4,
                                78f960da-dfbe-11e9-8a34-2a2ae2dbcce4,
                                78f96684-dfbe-11e9-8a34-2a2ae2dbcce4,
                                78faa9b8-dfbe-11e9-8a34-2a2ae2dbcce4,
                                08d3817b-4e54-4825-bc4b-0512b627d567,
                                0fc3d5c1-fd39-4899-b5c0-b094e28ff359,
                                a6985b15-5fd6-4bdf-93f6-62930a438464"
                                 answerLabels="
                                DTG/3TC/TDF 50/300/300 mg,
                                AZT/3TC 300/150 mg,
                                AZT/3TC/NVP 300/150/200 mg,
                                AZT/3TC 60/30 mg,
                                TDF/3TC 300/300 mg,
                                ABC/3TC 300/300 mg,
                                AZT/3TC/NVP 60/30/50 mg,
                                DTG 50 mg,
                                AZT 10 mg sp,
                                NVP 10 mg sp,
                                TDF/3TC/EFV 300/300/600 mg,
                                3TC 10 mg sp,
                                ABC/3TC 60/30 mg,
                                RAL/DRV/r 400/600/100mg,
                                DRV/ETV 300/100 mg,
                                ABC/3TC 120/60 mg"/>

                            <label>ARV #2</label>
                            <obs id="curremtARV2" conceptId="PIH:13162"
                                 answerDrugIds="
                                78fab02a-dfbe-11e9-8a34-2a2ae2dbcce4,
                                78f96210-dfbe-11e9-8a34-2a2ae2dbcce4,
                                78faa576-dfbe-11e9-8a34-2a2ae2dbcce4,
                                78f9780e-dfbe-11e9-8a34-2a2ae2dbcce4,
                                78f981d2-dfbe-11e9-8a34-2a2ae2dbcce4,
                                78faaaf8-dfbe-11e9-8a34-2a2ae2dbcce4,
                                35c6041e-0af3-4bab-887d-9db682a02248,
                                78f976c4-dfbe-11e9-8a34-2a2ae2dbcce4,
                                78faa710-dfbe-11e9-8a34-2a2ae2dbcce4,
                                78f98308-dfbe-11e9-8a34-2a2ae2dbcce4,
                                78f95e78-dfbe-11e9-8a34-2a2ae2dbcce4,
                                78f95d38-dfbe-11e9-8a34-2a2ae2dbcce4,
                                78f96526-dfbe-11e9-8a34-2a2ae2dbcce4,
                                c893970e-22b5-4cb9-8be2-1a9bff480235,
                                78f97b9c-dfbe-11e9-8a34-2a2ae2dbcce4,
                                29c9dd27-25f2-45c6-9708-93fe142a46ba,
                                0fc3d5c1-fd39-4899-b5c0-b094e28ff359"
                                 answerLabels="
                                DTG 50 mg,
                                EFV 600 mg,
                                TDF 300 mg,
                                NVP 200 mg,
                                ABC 300 mg,
                                LPV/r 40/10 mg,
                                ABC 60 mg,
                                LPV/r 100/25 mg,
                                LPV/r 80/20 mg,
                                ABC 20 mg,
                                LPV/r 200/50 mg,
                                ATV/r 300/100 mg,
                                NVP 50 mg,
                                RAL/ETV 400/100 mg,
                                EFV 200 mg,
                                ETV 100mg,
                                DRV/ETV 300/100 mg"/>

                            <!-- Other ARV -->
                            <label>
                                <uimessage code="pihcore.other"/>
                                ARV:
                            </label>
                            <obs conceptId="CIEL:5424"/>
                            <br/>

                            <!-- Treatment line -->
                            <label>
                                <uimessage code="pihcore.treatmentLine"/>
                            </label>
                            <obs conceptId="PIH:13115" style="radio"
                                 answerConceptIds="PIH:7428,PIH:7429,PIH:7430"/>
                        </obsgroup>
                    </p>
                </div>
            </div>

            <h4>
                <uimessage code="pihcore.antiTbTreatment"/>
            </h4>

            <p class="small">
                <obs id="takingAntiTB"
                     conceptId="CIEL:159798" style="radio"
                     answerConceptIds="CIEL:1065,CIEL:1066"
                     answerCodes="emr.yes,pihcore.none.label" >
                    <controls>
                        <when value="CIEL:1065" thenDisplay="#current-tb-meds"/>
                    </controls>
                </obs>
            </p>

            <div id="current-tb-meds" class="two-columns">
                <label>
                    <uimessage code="pihcore.startDate" />
                </label>
                <obs conceptId="CIEL:1113" />
                <br/>

                <p class="radio">
                    <obs conceptId="CIEL:1111" style="radio"
                         answerConceptIds="PIH:2406,PIH:2408,CIEL:159909"
                         answerCodes="pihcore.tb.initialTreatment,pihcore.tb.retreatment,pihcore.tb.mdrtbTreatment"
                         answerSeparator="&lt;br /&gt;" />
                    <obs conceptId="CIEL:160136" />
                </p>
            </div>

            <h4>
                <uimessage code="pihcore.prophylaxis"/>
            </h4>

            <table>
                <tr>
                    <td>
                        <label>
                            <uimessage code="pihcore.treatment" />
                        </label>
                    </td>
                    <td>
                        <label>
                            <uimessage code="pihcore.startDate" />
                        </label>
                    </td>
                    <td>
                        <label>
                            <uimessage code="pihcore.endDate" />
                        </label>
                    </td>
                </tr>

                <repeat>
                    <template>
                        <obsgroup groupingConceptId="PIH:2739">
                            <tr>
                                <td>
                                    <obs conceptId="PIH:2289" answerConceptId="{conceptMap}"
                                         answerLabel="{drugname}"
                                         toggle="{id: '{drugname}-current-treat', style: 'dim'}"/>
                                </td>
                                <td class="{drugname}-current-treat">
                                    <obs conceptId="CIEL:163526" />
                                </td>
                                <td class="{drugname}-current-treat">
                                    <obs conceptId="CIEL:164384" allowFutureDates="true" />
                                </td>
                            </tr>
                        </obsgroup>
                    </template>
                    <render conceptMap="CIEL:105281" drugname="Cotrimoxazole" />
                </repeat>

                <repeat>
                    <template>
                        <obsgroup groupingConceptId="PIH:2739">
                            <tr>
                                <td>
                                    <obs conceptId="PIH:2289" answerConceptId="{conceptMap}"
                                         answerLabel="{drugname}"
                                         toggle="{id: '{drugname}-current-treat', style: 'dim'}"/>
                                    <p class="radio {drugname}-current-treat">
                                        <obs conceptId="PIH:13154" style="radio"
                                             answerConceptIds="CIEL:159943, CIEL:159944" />
                                    </p>
                                </td>
                                <td class="{drugname}-current-treat">
                                    <obs conceptId="CIEL:163526" />
                                </td>
                                <td class="{drugname}-current-treat">
                                    <obs conceptId="CIEL:164384" allowFutureDates="true" />
                                </td>
                            </tr>
                        </obsgroup>
                    </template>
                    <render conceptMap="CIEL:78280"  drugname="Isoniazide" />
                </repeat>

                <repeat>
                    <template>
                        <obsgroup groupingConceptId="PIH:2739">
                            <tr>
                                <td>
                                    <obs conceptId="PIH:2289" answerConceptId="{conceptMap}"
                                         answerLabel="{drugname}"
                                         toggle="{id: '{drugname}-current-treat', style: 'dim'}"/>
                                </td>
                                <td class="{drugname}-current-treat">
                                    <obs conceptId="CIEL:163526" />
                                </td>
                                <td class="{drugname}-current-treat">
                                    <obs conceptId="CIEL:164384" allowFutureDates="true" />
                                </td>
                            </tr>
                        </obsgroup>
                    </template>
                    <render conceptMap="CIEL:76488"  drugname="Fluconazole" />
                    <render conceptMap="CIEL:74250"  drugname="Dapsone" />
                </repeat>

                <obsgroup groupingConceptId="PIH:2739">
                    <tr>
                        <td>
                            <obs conceptId="PIH:2289"
                                 answerConceptId="PIH:3120" answerCode="pihcore.other"
                                 toggle="{id: '{other-current-pro-treat}', style: 'dim'}"
                                 commentFieldLabel="specify:" />
                        </td>
                        <td class="other-current-pro-treat">
                            <obs conceptId="CIEL:163526" />
                        </td>
                        <td class="other-current-pro-treat">
                            <obs conceptId="CIEL:164384" allowFutureDates="true" />
                        </td>
                    </tr>
                </obsgroup>
            </table>
        </div>
    </section>

    <section id="complaint" sectionTag="fieldset" headerTag="legend" headerStyle="title" headerCode="pihcore.chiefComplaint.title">
        <div class="section-container">
            <p>
                <obs conceptId="CIEL:160531" style="textarea" id="chief-complaint"/>
            </p>
        </div>
    </section>

    <section id="tb-screen" sectionTag="fieldset" headerTag="legend" headerStyle="title"
             headerCode="pihcore.tbscreen.title">
        <div class="section-container">
            <table>
                <repeat with="['feverSweats','11565'],['wtLoss3kg','11566'],['cough','11567'],['tbContact','11568'],['painfulNodes','11569'],['bloodyCough','970'],['dyspnea','5960'],['chestPain','136']">
                    <tr>
                        <td>
                            <!-- TB symptom -->
                            <obs conceptId="PIH:11563"
                                 answerConceptId="PIH:{1}"
                                 answerCode="coreapps.yes"
                                 style="checkbox" />
                        </td>
                        <td>
                            <!-- No TB symptom -->
                            <obs conceptId="PIH:11564"
                                 answerConceptId="PIH:{1}"
                                 answerCode="coreapps.no"
                                 style="checkbox" />
                        </td>
                        <td>
                            <label>
                                <uimessage code="pihcore.tbscreen.{0}"/>
                            </label>
                        </td>
                    </tr>
                </repeat>
            </table>
            <br/>
            <p>
                <label>
                    <uimessage code="pihcore.tbSuspectedMessage" />
                </label>
            </p>
        </div>
    </section>


    <section id="sexual-activity" sectionTag="fieldset" headerTag="legend" headerStyle="title"
             headerCode="zl.consultNote.sexualActivities.label">
        <div class="section-container">
            <div class="two-columns">
                <p class="radio">
                    <label>
                        <uimessage code="zl.sexuallyActive"/>?
                    </label>
                    <obs conceptId="CIEL:160109"
                         answerConceptIds="CIEL:1065,CIEL:1066" style="radio"/>
                </p>

                <p class="radio">
                    <label>
                        <uimessage code="pihcore.familyPlanning.title"/>?
                    </label>
                    <obs conceptId="CIEL:1382" style="checkbox"
                         answerConceptId="CIEL:1065" toggle="fp-table" />
                </p>
            </div>

            <table id="fp-table">
                <tr>
                    <td>
                        <label>
                            <uimessage code="pihcore.familyPlanning.method"/>
                        </label>
                    </td>
                    <td>
                        <label>
                            <uimessage code="pihcore.startDate"/>
                        </label>
                    </td>
                </tr>

                <repeat>
                    <template>
                        <obsgroup groupingConceptId="PIH:Family planning construct">
                            <tr>
                                <td id="{comment}-fp">
                                    <obs conceptId="CIEL:374"
                                         answerConceptId="{fpMethod}"
                                         style="checkbox"
                                         toggle="{id: '{comment}-date', style: 'dim'}"
                                    />
                                </td>
                                <td class="{comment}-date">
                                    <obs conceptId="CIEL:163757"/>
                                </td>
                            </tr>
                        </obsgroup>
                    </template>
                    <render fpMethod="CIEL:780" comment="Pill"/>
                    <render fpMethod="CIEL:907" comment="Depo-provera"/>
                    <render fpMethod="CIEL:190" comment="Condoms"/>
                    <render fpMethod="CIEL:78796" comment="Norplant"/>
                    <render fpMethod="CIEL:5275" comment="IUD"/>
                    <render fpMethod="CIEL:1472" comment="TubalLigation"/>
                    <render fpMethod="CIEL:1489" comment="Vasectomy"/>
                </repeat>

                <!-- Other family planning -->
                <obsgroup groupingConceptId="PIH:Family planning construct">
                    <tr>
                        <td>
                            <obs conceptId="CIEL:374"
                                 answerConceptId="CIEL:5622"
                                 style="checkbox"
                                 toggle="{id: 'other-fp', style: 'dim'}"
                            />
                        </td>
                        <td class="other-fp">
                            <obs conceptId="CIEL:163757"/>
                        </td>
                    </tr>
                </obsgroup>
                <tr>
                    <td align="left" class="other-fp">
                        <label>
                            <uimessage code="zl.ifOtherSpecify"/>
                        </label>
                        <obs conceptId="PIH:2996" size="30"/>
                    </td>
                    <td></td>
                </tr>
            </table>

            <includeIf velocityTest="$patient.gender == 'F' ">
                <br/>
                <!-- Pregnant -->
                <p>
                    <obs conceptId="CIEL:5272" toggle="pregnant"
                         answerConceptId="CIEL:1065"
                         answerCode="pihcore.pregnant"
                         style="checkbox"/>

                    <div id="pregnant">
                        <div class="two-columns">
                            <!-- Last menstrual period (LMP or DDR) -->
                            <p>
                                <label>
                                    <uimessage code="pihcore.pregnancy.lastPeriod"/>
                                </label>
                                <span class="small">
                                    <obs id="lastPeriodDate" conceptId="CIEL:1427" />
                                </span>
                            </p>

                            <!-- Due date (DPA) -->
                            <p>
                                <label>
                                    <uimessage code="pihcore.pregnancy.dueDate"/>
                                </label>
                                <span class="small">
                                    <obs conceptId="CIEL:5596" allowFutureDates="true"/>
                                </span>
                            </p>
                        </div>

                        <div id="calculated-edd-and-gestational" class="two-columns hidden">
                            <p>
                                <span id="calculated-gestational-age-wrapper">
                                    <span id="calculated-gestational-age-label">
                                        <uimessage code="pihcore.calculatedGestationalAge"/>:&#160;
                                    </span>
                                    <span id='calculated-gestational-age-value' class="value"></span>
                                </span>
                            </p>
                            <p>
                                <span id="calculated-edd-wrapper">
                                    <span id="calculated-edd-label">
                                        <uimessage code="pihcore.calculatedEstimatedDeliveryDate"/>:&#160;
                                    </span>
                                    <span id='calculated-edd' class="value"></span>
                                </span>
                            </p>

                        </div>
                    </div>
                </p>
            </includeIf>

        </div>
    </section>


    <section id="psych" sectionTag="fieldset" headerTag="legend" headerStyle="title"
             headerCode="pihcore.psycState">
        <div class="section-container">
            <includeIf velocityTest="$patient.getAge($encounter.getEncounterDatetime()) &gt; 12 || $patient.getAge($encounter.getEncounterDatetime()) == 12 || (! $patient.age)">
                <p>
                    <label>
                        <uimessage code="pihcore.patientReceivedAdvice" />
                    </label>
                    <br/>

                    <repeat>
                        <template>
                            <obs conceptId="CIEL:163560"
                                 answerConceptId="{response}"
                                 answerCode="{text}"
                                 style="checkbox" />
                            <br/>
                        </template>
                        <render response="CIEL:151185" text="pihcore.cervicalCancerScreeningTreatment"/>
                        <render response="CIEL:165489" text="pihcore.lowRiskBehavior" />
                        <render response="CIEL:1382"   text="pihcore.fpCounseling" />
                        <render response="CIEL:163559" text="pihcore.stiScreening" />
                        <render response="CIEL:159381" text="pihcore.partnerScreening" />
                    </repeat>
                </p>
            </includeIf>

            <p class="radio">
                <label>
                    <uimessage code="pihcore.referredMH" />
                </label>
                <obs conceptId="PIH:13002" answerConceptIds="CIEL:1066,CIEL:1065"
                     answerSeparator="" style="radio" />

            </p>
        </div>
    </section>

    <section id="hiv-adherence" sectionTag="fieldset" headerTag="legend" headerStyle="title"
             headerCode="pihcore.arvAdherence">
        <div class="section-container">
            <label>
                <uimessage code="pihcore.med.rxDosesMonth" />
            </label>
            <obs conceptId="PIH:13067" />
            <br/>

            <label>
                <uimessage code="pihcore.med.missedDosesMonth" />
            </label>
            <obs conceptId="CIEL:160110" />
            <br/>

            <label>
                <uimessage code="pihcore.dailyCHWvisit" />
            </label>
            <p class="small">
                <obs id="chwVisit"
                     conceptId="CIEL:160111" style="radio"
                     answerConceptIds="CIEL:1065,CIEL:1066">
                    <controls>
                        <when value="CIEL:1066" thenDisplay="#reason-without-chw"/>
                    </controls>
                </obs>
            </p>

            <div id="reason-without-chw">
                <label>
                    <uimessage code="pihcore.ifNotSpecifyReason" />
                </label>
                <obs conceptId="PIH:13065"  />
            </div>
        </div>
    </section>

    <section id="hiv-adverse-event" sectionTag="fieldset" headerTag="legend" headerStyle="title"
             headerCode="pihcore.adverseEvent">
        <div class="section-container">
            <div id="ae">
                <table>
                    <tr>
                        <th>
                            <label>
                                <uimessage code="pihcore.adverseEvent"/>
                            </label>
                        </th>
                        <th>
                            <label>
                                Date
                            </label>
                        </th>
                    </tr>

                    <repeat>
                        <template>
                            <obsgroup groupingConceptId="PIH:1295">
                                <tr>
                                    <td id="{name}-ae">
                                        <obs conceptId="PIH:1297"
                                             answerConceptId="{concept}"
                                             style="checkbox"
                                             toggle="{id: '{name}-ae-date', style: 'dim'}" />
                                    </td>
                                    <td id="{name}-ae-date">
                                        <obs conceptId="PIH:1300" />
                                    </td>
                                </tr>
                            </obsgroup>
                        </template>
                        <render concept="CIEL:1107"   name="None"/>
                        <render concept="CIEL:118983" name="Neuropathy"/>
                        <render concept="CIEL:136162" name="LacticAcidosis" />
                        <render concept="CIEL:133473" name="NauseaVomiting" />
                        <render concept="CIEL:116986" name="Hepatitis" />
                        <render concept="CIEL:121629" name="Anemia"/>
                        <render concept="CIEL:136443" name="Jaundice"/>
                        <render concept="CIEL:512"    name="Rash" />
                    </repeat>
                    <repeat>
                        <template>
                            <obsgroup groupingConceptId="PIH:1295">
                                <tr>
                                    <td id="{name}-ae">
                                        <obs conceptId="PIH:1297"
                                             answerConceptId="{concept}"
                                             style="checkbox"
                                             commentFieldLabel="(préciser)"
                                             toggle="{id: '{name}-ae-date', style: 'dim'}" />
                                    </td>
                                    <td id="{name}-ae-date">
                                        <obs conceptId="PIH:1300" />
                                    </td>
                                </tr>
                            </obsgroup>
                        </template>
                        <render concept="CIEL:5622" name="Other" />
                    </repeat>
                </table>
            </div>
        </div>
    </section>

    <section id="hiv-progress" sectionTag="fieldset" headerTag="legend" headerStyle="title"
             headerCode="pihcore.progress">
        <div class="boxed">
            <p>
                <label>
                    <uimessage code="pihcore.hiv.clinicalState.short"/>
                </label>
                <obs conceptId="CIEL:160116"
                     answerConceptIds="PIH:GOOD,PIH:SATISFACTORY,CIEL:162679,PIH:DETERIORATION"
                     style="radio" />
            </p>
        </div>
    </section>

    <includeIf velocityTest="$patient.getAge($encounter.getEncounterDatetime()) &gt; 12 || $patient.getAge($encounter.getEncounterDatetime()) == 12 || (! $patient.age)">
        <section id="hiv-state-stage" sectionTag="fieldset" headerTag="legend" headerStyle="title"
                 headerCode="pihcore.hiv.clinicalStage">
            <div class="boxed">
                <p>
                    <label>
                        <uimessage code="pihcore.hiv.whoStages"/>
                    </label>
                    <obs conceptId="PIH:CURRENT WHO HIV STAGE"
                         answerConceptIds="CIEL:1204,CIEL:1205,CIEL:1206,CIEL:1207"
                         answerLabels="1,2,3,4" style="radio" />
                </p>

                <!-- UHM-4784 Use Lab results or workflow to enter lab data.  Using includeif to comment out the section -->
                <includeIf velocityTest="$patient.gender == 'NoLabEntryHere' ">
                    <!-- ToDo:  Duplicate of section A.  Valery says this is different and used to calculate stage.  -->
                    <obsgroup groupingConceptId="PIH:3434">
                        <obs conceptId="CIEL:5497" labelCode="pihcore.lab.cd4Count"/>
                        <br/>
                        <obs conceptId="PIH:10783" labelCode="CD4 Date:" />
                    </obsgroup>
                </includeIf>
            </div>
        </section>
    </includeIf>

    <section id="hiv-oi" sectionTag="fieldset" headerTag="legend" headerStyle="title"
             headerCode="pihcore.oi.title">
        <div class="section-container">
            <label>
                <uimessage code="pihcore.hiv.enterOI"/>
            </label>
            <br/>

            <div class="two-columns">
                <repeat with="['One'],
                              ['Two'],
                              ['Three'],
                              ['Four']">
                    <obsgroup groupingConceptId="PIH:Visit Diagnoses" showIfEmpty="false">
                        <obs conceptId="PIH:DIAGNOSIS"
                             answerConceptSetIds="PIH:HUM opportunistic infection"
                             style="autocomplete"/>
                    </obsgroup>
                </repeat>
            </div>
        </div>
    </section>

    <ifMode mode="VIEW" include="false">
        <div id="buttons">
            <button id="next" type="button" class="submitButton confirm right">
                <uimessage code="emr.next"/>
                <i class="icon-spinner icon-spin icon-2x" style="display: none; margin-left: 10px;"></i>
            </button>
            <button id="submit" class="submitButton confirm right">
                <uimessage code="mirebalais.save"/>
                <i class="icon-spinner icon-spin icon-2x" style="display: none; margin-left: 10px;"></i>
            </button>
            <button id="cancel" type="button" class="cancel">
                <uimessage code="emr.cancel"/>
            </button>
        </div>
    </ifMode>

</htmlform>
