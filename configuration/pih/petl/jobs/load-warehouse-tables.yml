type: "iterating-job"
configuration:
  execution:
    maxConcurrentJobs: 1  # Import into up to 5 sites concurrently
    maxRetriesPerJob: 10
    retryInterval: 30
    retryIntervalUnit: "MINUTES"
  iterations:
    - siteName: "cange"   #siteName is populated in each table and also used to identify the appropriate data source
      partitionNum: "1"   #partitionNum is used to identify the sqlserver partition that this site's data is loaded into
      tableSuffix: "_1"   #tableSuffix is used as a means to create the staging table used prior to moving the partition
    - siteName: "hinche"
      partitionNum: "2"
      tableSuffix: "_2"
    - siteName: "hsn"
      partitionNum: "3"
      tableSuffix: "_3"
  jobTemplate:
    type: "job-pipeline"
    configuration:
      jobs:
        - type: "sql-execution"
          configuration:
            datasource: "openmrs-${siteName}.yml"
            delimiter: ";"
            scripts:
              - "../../liquibase/sql/create_views.sql"
        - type: "sql-execution"
          configuration:
            datasource: "openmrs-${siteName}.yml"
            delimiter: "#"
            scripts:
              - "../../liquibase/sql/create_functions.sql"
              - "../../liquibase/sql/global_metadata.sql"
        - type: "iterating-job"
          configuration:
            execution:
              maxConcurrentJobs: 1  # Import into up to 1 tables concurrently
            jobTemplate:
              type: "job-pipeline"
              configuration:
                jobs:
                  - type: "sql-execution"
                    configuration:
                      datasource: "warehouse.yml"
                      scripts:
                        - "warehouse/scripts/drop-table-if-exists.sql"

                  - type: "sqlserver-bulk-import"
                    configuration:
                      extract:
                        datasource: "openmrs-${siteName}.yml"
                        query:  "openmrs/extractions/${tableName}.sql"
                        context: "openmrs/extractions/context.sql"
                        extraColumns:
                          site: "'${siteName}'"
                          partition_num: "${partitionNum}"
                      load:
                        datasource: "warehouse.yml"
                        table: "${tableName}${tableSuffix}"
                        schema: "warehouse/tables/${tableName}.sql"

                  - type: "sql-execution"
                    configuration:
                      datasource: "warehouse.yml"
                      scripts:
                        - "warehouse/scripts/move-partition.sql"

            iterations:
              #- tableName: "all_lab_orders"
              #- tableName: "all_lab_results"
              - tableName: "covid_admission"
              - tableName: "covid_diagnoses"
              - tableName: "covid_discharge"
              - tableName: "covid_disposition"
              - tableName: "covid_lab_test"
              - tableName: "covid_visit"
              - tableName: "datakind_encounter"
              - tableName: "datakind_patient_program"
              - tableName: "datakind_registration"
              #- tableName: "diagnoses"
              #- tableName: "echocardiogram"
              - tableName: "hiv_dispensing"
              - tableName: "hiv_patient"
              - tableName: "hiv_patient_program"
              - tableName: "hiv_regimens"
              - tableName: "hiv_status"
              - tableName: "hiv_viral_load"
              - tableName: "hiv_visit"
              - tableName: "mch_birth"
              #- tableName: "mch_delivery"
              - tableName: "mch_patient"
              - tableName: "mch_pregnancy"
              - tableName: "mch_status"
              - tableName: "mch_visit"
              - tableName: "ovc_program_encounters"
              - tableName: "tb_lab_results"
              - tableName: "tb_screening"
              - tableName: "vaccinations_anc"