# Template that takes in the following parameters

# ${tableName}
# ${siteName}
# ${partitionNum}

# The purpose of this job is to batch load the result of the given query into a specific partition in the target table

# 1. Drops ${tableName}${tableSuffix} if it exists
# 2. Queries openmrs-${siteName} datasource with the openmrs/extractions/${tableName}.sql query
# 3. Adds site=${siteName} and partition_num=${partitionNum} to the source query
# 4. Creates ${tableName}${tableSuffix} with warehouse/tables/${tableName}.sql schema and streams query results into it
# 5. Moves the data from ${tableName}${tableSuffix} into ${tableName}
# 6. Drops the ${tableName}${tableSuffix} table

type: "sqlserver-bulk-import"
  configuration:
    extract:
      datasource: "openmrs-${siteName}.yml"
      query:  "extractions/${tableName}.sql"
      context: "extractions/context.sql"
    load:
      datasource: "warehouse.yml"
      table: "${tableName}"
      schema: "tables/${tableName}.sql"
      extraColumns:
        - name: "site"
          type: "VARCHAR(100)"
          value: "'${siteName}'"
        - name: "partition_num"
          type: "INT"
          value: "${partitionNum}"
      partition:
        scheme: "psSite"
        column: "partition_num"