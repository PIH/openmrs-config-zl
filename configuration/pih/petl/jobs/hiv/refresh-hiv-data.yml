# For the HIV Server, we only execute the "hiv", "ovc", and "hivmigration" ETL jobs

type: "job-pipeline"
parameters:
  - siteName: "hiv"
configuration:
  jobs:
    - path: "templates/create-source-views-and-functions/job.yml"
    - type: "iterating-job"
      configuration:
        execution:
          maxConcurrentJobs: 1  # Import into up to 1 tables concurrently
        jobTemplate:
          type: "sqlserver-bulk-import"
          configuration:
            extract:
              datasource: "openmrs-${siteName}.yml"
              query:  "hiv/extractions/${tableName}.sql"
            load:
              datasource: "warehouse.yml"
              table: "${tableName}"
              schema: "hiv/tables/${tableName}.sql"
        iterations:
          - tableName: "hiv_dispensing"
          - tableName: "hiv_patient"
          - tableName: "hiv_patient_program"
          - tableName: "hiv_regimens"
          - tableName: "hiv_status"
          - tableName: "hiv_viral_load"
          - tableName: "hiv_visit"
          - tableName: "ovc_program_encounters"
          - tableName: "hivmigration_data_warnings.sql"

    - type: "sqlserver-bulk-import"
      configuration:
        extract:
          datasource: "openmrs-${siteName}.yml"
          query:  "hiv/extractions/hivmigration_aggregrate_data_warnings.sql"
        load:
          datasource: "warehouse.yml"
          table: "hivmigration_aggregrate_data_warnings"
          schema: "hiv/tables/hivmigration_aggregrate_data_warnings.sql"
          dropAndRecreateTable: "false"